# 网络基础知识

> 前言：之前以为这一部分总结地还算完整，但是最近发现还是有很多东西没考虑到，所以重新整理一下这一部分内容。

对于网络基础知识，我会大体上分为这么几部分

* 整体概念。OSI七层和TCP/IP四层
* HTTP和HTTPS协议。HTTP1、HTTP2、HTTP3的比较
* TCP协议。从TCP三次握手四次挥手说起
* UDP协议。
* DNS和ARP协议。
* 加密算法，证书验证签名全过程

### HTTP和HTTPS

HTTPS的握手过程，HTTP和HTTPS的区别

相比HTTP协议，HTTPS协议主要是多了SSL（记录协议，数据封装、压缩和加密）/TLS（握手协议，协商加密算法、身份认证、交换加密密钥）协议。

HTTP和HTTPS的一些区别：

* 证书
* HTTP是超文本明文传输，HTTPS是ssl加密传输
* 端口不一致
* HTTP是无状态的，也是无连接的（借助于底层的TCP虚拟连接）

##### HTTP1和HTTP2协议

HTTP/1.x和HTTP/2（基于SPDY，多路复用、二进制分帧、首部压缩、server push）

HTTP/2拥有和HTTP1相同的请求格式，但得到了很大的优化：多路复用，服务器Push

##### QUIC协议

HTTP/3（基于UDP的QUIC，完美解决队头堵塞，0RTT建连——解决TCP+TLS建立连接的延时）做了哪些优化

QUIC借助了UDP的优点，同时做了什么优化。QUIC在UDP基础上增加了一层保证数据的可靠传输。集成TLS，解决加密问题。多路复用，同一物理连接上可以有多个独立的逻辑数据流，避免队头阻塞。

##### 参考资料

[参考资料](https://blog.csdn.net/howgod/article/details/102597450)

[网络知识总结](https://juejin.im/post/6844904202523639822#heading-6) 

本文中比较详细地阐述了HTTPS的握手过程，以及三个握手过程三个随机数的作用。不足的是没有讨论HTTP的不同版本，例如基于SPDY的HTTP/2和基于QUIC的HTTP/3

### TCP协议

对于TCP协议，我们通过探讨下面的一些问题，进而大概了解TCP协议的机制

#### TCP的三次握手和四次挥手做了什么，为什么是三次和四次

三次握手交换序列号、在建立连接的前提下避免历史连接，四次挥手确保内容完整传输

三次握手时的状态转移

四次挥手时的状态转移

##### 建立连接是否一定是三次

当两端同时发起SYN建立连接时，会出现四次握手来建立连接。

##### TCP连接的初始化序列号能否固定

ISN现在的实现大多是在一个基准值的基础上进行随机，否则服务器对于历史连接的ACK包发到客户端时，ACK包中的确认序列号和客户端的序列号无法对应。

##### 当Client发送SYN包后就挂了，连接超时怎么办

> 心跳保活机制

发送SYN+ACK后，为了避免连接一直占用Server的SYN连接队列中的位置，Server维护了一个超时重传机制，默认在进行五次重发SYN+ACK包后，如果还没有收到确认则断开这一连接，重试时间间隔指数级增长。（这一机制给攻击者提供了DDOS攻击服务器的机会，我们可以通过配置服务器的参数应对）

##### TCP的两端同时断开连接

如果Peer在FIN_WAIT1状态下首先收到对端Peer的FIN包，那么该Peer在确认已经收到了对端全部的Data数据包后，就响应了一个ACK给对端Peer，然后自己进入CLOSEING状态，那么两端Peer就可能出现完全一样的状态转移FIN_WAIT1——>CLOSEING——>TIMEWAIT，也就是Clien和Server最后同时进入TIME_WAIT状态

##### 四次挥手能不能变成三次挥手

是有可能的。TCP是全双工通信，如果Client没有新的数据发送给Server，可以发送FIN信号告知Server，这个时候Server可以继续发送数据给Client，但是如果这时Server没有数据发送给Client了，Server可以将FIN和ACK合并发送给Client，这样四次挥手就变成了三次

四次挥手阶段，除同时断开连接的特殊情况外，主动关闭的一方最后进入TIME_WAIT阶段，主要是为了在最后阶段主动关闭方发送的ACK丢失后，主动关闭方进入了TIME_WAIT阶段等待被动关闭方的FIN重传，并再次发送ACK

TIME_WAIT阶段主要用来解决以下几个问题：

* 最后阶段主动关闭方可以重传丢失的FIN的ACK
* 防止已经断开的连接1中在链路中残留的FIN包终止掉新的连接2，概率性问题
* 防止链路上已经关闭的连接的残余数据包干扰正常的数据包，会造成数据流的不正常，同问题2

TIME_WAIT带来的问题

* 一个连接进入TIME_WAIT状态后需要等待2*MSL时间才能断开连接，释放连接占用的资源。如果短时间内有大量的短连接，这既会消耗服务器的连接资源，也会消耗客户端的端口资源

TIME_WAIT的清理技巧

* TIME_WAIT的快速回收策略。打开后，会缩短TIME_WAIT的时间，但是会快速回收策略会拒绝同时满足三种情况的新连接
* TIME_WAIT重用。只要满足下面两点中的一点，一个TW的四元组（Socket连接）就可以重新被新到来的SYN连接使用
  * 新连接SYN告知的初始序列号比TIME_WAIT老连接的末序列号大
  * 如果开启了tcp_timestamps，并且新到来的连接的时间戳比老连接的时间戳大
* 奇技怪巧1:修改控制并发TIME_WAIT数量的变量的值，超过阈值的TIME_WAIT会被清除
* 奇技怪巧2:利用RST包从外部清掉TIME_WAIT链接

#### TCP协议的延迟确认和重传机制是怎样的

序列号（确认机制）、重传机制、拥塞控制算法、流量控制（滑动窗口）

#### TCP协议的拥塞控制和流量控制有什么区别

拥塞控制是针对于整个网络环境的，流量控制是针对于点对点通信环境的

##### 拥塞控制算法

慢开始、拥塞避免、快重传、快恢复

##### 流量控制算法

> TCP通过滑动窗口实现流量控制

滑动窗口基于序列号的确认机制，对端发送报文时会附带可接受的最大窗口值

#### TCP协议可能会受到什么攻击，可能会避免什么攻击（优势和劣势）

连接阶段的特性导致可能受到SYN攻击，内核收到RST将会产生一个错误并终止该连接的特性可能收到RST攻击

#### TCP和UDP的一些比较

我们常拿TCP协议和UDP协议联系起来比较，下面是TCP和UDP的一些区别

* TCP面向连接，建立和释放连接都需要双方彼此通信
* TCP和UDP都支持全双工服务，但TCP支持字节流传输，UDP支持报文传输
* TCP可靠传输：校验和和确认机制检查数据安全，拥塞控制和重传功能
* 相对的，UDP是一种无连接、不可靠、面向报文的传输层协议，对报文提供了可选的校验和保证数据正确性外，如果检测到收到的分组有差错就丢掉这个分组
* UDP支持一对一、一对多和多对多的交互式通信（支持广播？），而TCP只支持一对一的单播

##### 参考阅读

[彻底搞懂TCP协议：从 TCP 三次握手四次挥手说起](https://zhuanlan.zhihu.com/p/199284611)

### DNS和ARP协议

网络层的路由选择和分组转发、IP协议解析（ARP地址解析协议）

ARC协议根据IP确定相邻目标主机的MAC地址，DNS根据域名解析出对应的IP地址



### 加密算法和证书验证签名

非对称加密算法：RSA、ECC和DH

双方互相持有对方的公钥和自己的私钥。如何验证公钥和私钥的正确：CA。RSA原理：两个大素数作为私钥，而大素数的乘积作为公钥，因为大素数相乘是十分容易，而对乘积进行因式分解却很难。

[参考资料](https://blog.csdn.net/u014294681/article/details/86705999)



PS： 参考网络部分笔记，参考链接：
