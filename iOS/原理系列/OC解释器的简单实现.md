# OC解释器的实现

本篇文章的内容基于**《跟戴铭学iOS编程》**一书中的OC解释器实现部分。简单阐述了**解释器的工作原理**和**OC解释器的简单实现**。希望通过对这一部分知识的整理和思考，更深入地了解解释器的工作机制。

## 解释器做了什么

解释器又称为直译器，能够把解释型高级编程语言一行一行地直接转译执行。解释器不会通过把所有源代码生成可执行程序的方式执行，而是像一个“中间人”，每次运行程序都要先转成另一种语言再运行。

从计算理论的角度讲，每个程序都是一台机器的“描述”，而解释器是在**“模拟”这台机器的运转**，也就是在进行“运算”。所以从某种意义上讲，解释器就是计算的本质，当然，不同的解释器就会带来不同的计算。

一个解释器可大可小，大可以是复杂的CPU，小也可以是一个简单的字符串解析，但本质上它们都是对特定的语法做出合理的解释。

**认识编译器**

编译型语言需要编译器处理，主要的工作流程如下：

源代码——预处理器——编译器——目标代码——链接器——生成可执行程序

在这个过程中，编译器调用预处理器，将源代码进行预处理（清除注释、宏定义、包含文件和条件编译）。通过把经过预处理的源代码编译成目标代码（二进制机器语言），再调用链接器外加库文件，从而形成可执行程序，让机器能够执行。

需要注意的是，编译过程中，编译器会针对不同的CPU架构和操作系统进行编译，这样才能在特定的机器上运行程序。所以最后编译得到的目标代码会和机器的CPU架构相匹配，库文件会和操作系统相匹配。

**认识解释器**

解释型语言可以通过解释器处理，主要工作流程如下：

源代码——解释器

在这个过程中，源代码无需**预先编译**成可执行程序，在程序执行的过程中，解释器每读取一句源代码，会对源代码进行词法分析和语法分析，再将源代码转换为解释器能够执行的中间代码（字节码），最后，由解释器将中间代码解释为可执行的机器指令。

#### 解释器和编译器的区别

编译型语言在经过编译后，得到可执行程序，可执行程序产生的是直接执行机器指令，而解释型语言的每一句源代码都要经过解释器解释为可执行的机器指令，所以**解释型语言的执行效率会比编译型语言的执行效率低。**

但是，解释型语言在不同的平台都有对应的解释器，源代码**可以跨平台**，开发人员只需编写代码，无需再考虑每个平台的编译，编写完的代码在任何平台都能无需修改（或者少量修改）就能正确执行。

## 解释器的工作原理

通过词法分析、语法分析、建立语法抽象树、并进行静态分析。在静态分析通过后，解释器可以通过对AST语法树进行解析，将特定语言的实现，转化成对应的。

#### 字节码

第一次翻译时，吧源代码完整地进行转换，编译成更高效的字节码。如果后续源代码文件没有修改，就直接将对应字节码直接翻译成机器指令执行，从而提高速度。

#### JIT即时编译

对于重复的内容，翻译一次后就把它保存，再后续再次编译时，如果碰到相同的内容就直接使用保存的翻译结果，而无需每次都重新翻译。重复内容包括多次调用的方法体和多次执行的循环体。

## OC解释器的设计与实现

更类似于伪代码解释器，是先将程序的源代码转化为某种与机器无关的中间代码，然后再执行中间代码。而一般的源代码解释器不需要一个独立的编译过程，每次读入一条语句，并且根据这条语句执行特定的操作，以此类推。

本文中，我们使用Swift实现了一个OC解释器，往解释器输入一段OC实现的源代码，通过解释执行，得到代码的运算结果。在这个解释器中，我们去掉了很多OC语言的复杂语法和特性。

实现的OC解释器虽然过于简单，但并不影响我们的学习，相反，我们应先确保简单的功能实现正确，后续可以慢慢加入其它元素。

### 一些数据模型的约定

* OCToken类的设计

* OCAST抽象语法树节点的设计

### 词法分析器的实现

* 设置过滤规则
* 遍历文本
* 切Token
* 根据不同类型的token，进行对应处理

### 语法分析器的实现

* 根据token有序集合，生成对应的AST节点，并构建AST语法树
* 对应节点的处理，例如操作节点
* 优先级规则的加入，例如按优先级运算

### 静态分析器的实现

通过静态分析器，我们可以分析输入的OC代码是否合法，代码中的变量是否在使用前已经初始化，以避免导致奇怪的后果。

* 使用访问者模式的考虑
* 静态分析器中多级符号表的建立与更新
* 符号表元素的数据模型
* 符号表的相关操作

## 参考文章

* [解释器——百度百科]([https://baike.baidu.com/item/%E8%A7%A3%E9%87%8A%E5%99%A8/10418965?fr=aladdin](https://baike.baidu.com/item/解释器/10418965?fr=aladdin))
* [编译器和解释器的区别和工作原理](http://www.opython.com/1355.html)
* [怎么写一个解释器](http://www.yinwang.org/blog-cn/2012/08/01/interpreter)