# 优化iOS APP启动

## 了解Mach-O
Mach-O是iOS系统不同运行时期可执行的文件的文件类型统称，主要分为以下三类：

- **Executable：**可执行文件
- **Dylib：**动态库
- **Bundle：**苹果特有的类型，是无法被连接的Dylib

Mach-O的文件基本结构可分为三个部分：

- **Header**，包括了Mach-O文件的基本信息，如CPU架构、文件类型和加载指令数量等
- **Load Commands**，是跟在Header后面的加载命令区，包含文件的组织架构和在虚拟内存中的布局方式，在调用的时候知道如何设置和加载二进制数据
- **Data**，包含Load Commands中需要的各个Segment的数据

大多数Mach-O的文件会包含以下三种Segment：

- **__TEXT**：代码段，包括头文件、代码和常量等，只读
- **__DATA**：数据段，包括全局变量，静态变量等，可读可写
- **__LINKEDIT**：如何加载程序，包含了方法和变量的元数据（位置，偏移量），以及代码签名等信息，只读

## 了解其它的文件类型
避免以后碰到相关的问题时一脸懵

### Image
指的是Executable，Dylib或者Bundle的一种

### Framework
很多东西都可以称为framework，这里指的是dylib

### Virtual Memory
虚拟内存是建立在物理内存和进程之间的中间层。虚拟内存在逻辑上连续，但在物理上是离散分布的。需要注意的是

1. 逻辑地址可以没有对应的实际物理内存地址
2. 多个逻辑地址可以对应到一个物理内存地址上

#### Page Fault
页缺失，当进程访问一个没有对应物理地址的逻辑地址时，因为找不到对应的页，而发出的信号

#### Lazy Reading
当发生Page Fault时，系统通过mmap()函数读取指定页，这个过程就叫做Lazy Reading

#### Copy-On-Write 
当进程需要对某一页内容进行修改时，内核会把需要修改部分先复制一份，然后再修改，并把逻辑地址重新映射到新的物理内存，这个过程就叫做COW

#### Dirty Page & Clean Page
Image加载后，被修改过内容的Page叫做Dirty Page，会包含着进程特定的信息；与之相对的叫Clean Page，可以直接从磁盘重新生成。Dirty Page是进程独有，不能被共享

#### 共享内存 （Share RAM）
当多个Mach-O都依赖同一个Dylib时，系统会让这几个Mach-O的调用Dylib的逻辑地址都指向同一块物理内存区域，从而实现内存共享。

## 启动APP
APP启动类型分为三种

- 冷启动，满足以下几个条件
	- 重启之后，未启动过该应用
	- APP不在内存中
	- 没有相关的进程存在
- 热启动，满足以下几个条件
	- APP刚被终止
	- APP还没有完全从内存中移除
	- 没有相关的进程存在
- 挂起后再启动，指的是被挂起的APP继续的过程，需要满足以下几个条件
	- APP被挂起
	- APP好全部在内存中
	- 还存在相关的进程

